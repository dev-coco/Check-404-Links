<?php if(isset($argv[1])){$START_URL=$argv[1];}$liste=array($START_URL);$arrParent=array();$cpt=array();$i=0;while($i<count($liste)){$url=new URL($liste[$i]);$tmpcode=$url->getHttpCode();if(isset($cpt[$tmpcode])){$cpt[$tmpcode]++;}else{$cpt[$tmpcode]=1;}if($tmpcode==404){sendMsg("\n=> 404 URL".' : '.$url->getUrl());reset($arrParent);foreach($arrParent as $tmp){list($tmpParent,$tmpEnfant)=explode('|',$tmp);if($liste[$i]==$tmpEnfant){sendMsg("Error page".' : '.$tmpParent);}}}$c=count($liste);$arrChilds=array();if($c<=1000&&preg_match("@".$liste[0]."@",$url->getUrl())){$arrChilds=findChilds($url);}foreach($arrChilds as $urltmp){if(!in_array($urltmp,$liste)){$liste[]=$urltmp;}if(!in_array($liste[$i].'|'.$urltmp,$arrParent)){$arrParent[]=$liste[$i].'|'.$urltmp;}}$i++;}sendMsg('');function sendMsg($data){echo"$data\n";}function findChilds($url){$arrOut=array();$arrUrlInfos=parse_url($url->getUrl());if($url->getContent()==''){return $arrOut;}$html=str_get_html($url->getContent());if(!$html){return $arrOut;}foreach($html->find('img')as $element){$tmp=chemin($element->src,$arrUrlInfos,$url->getUrl());if($tmp!=''){$arrOut[]=$tmp;}}foreach($html->find('a')as $element){$tmp=chemin($element->href,$arrUrlInfos,$url->getUrl());if($tmp!=''){$arrOut[]=$tmp;}}foreach($html->find('link')as $element){$tmp=chemin($element->href,$arrUrlInfos,$url->getUrl());if($tmp!=''){$arrOut[]=$tmp;}}foreach($html->find('script')as $element){$tmp=chemin($element->src,$arrUrlInfos,$url->getUrl());if($tmp!=''){$arrOut[]=$tmp;}}return $arrOut;}function chemin($fic,$urlInfos,$parent){if(preg_match('/^\/\//',$fic)){return $urlInfos['scheme'].':'.$fic;}if(substr($fic,0,1)=='/'){return $urlInfos['scheme'].'://'.$urlInfos['host'].$fic;}if(substr($fic,0,1)=='.'){return url_to_absolute($parent,$fic);}if(preg_match('/^http\:\/\//',$fic)){return $fic;}if(preg_match('/^https\:\/\//',$fic)){return $fic;}if(preg_match('/^javascript\:/',$fic)){return '';}if(preg_match('/^mailto\:/',$fic)){return '';}if(preg_match('/^tel\:/',$fic)){return '';}if(preg_match('/^data\:/',$fic)){return '';}if(preg_match('/^irc\:/',$fic)){return '';}$r=$urlInfos['scheme'].'://'.$urlInfos['host'];if(!isset($urlInfos['path'])){$r.='/'.$fic;return $r;}$last=strrpos($urlInfos['path'],'/');$sub=substr($urlInfos['path'],0,$last);$r.=$sub.'/'.$fic;return $r;}class URL{private $_url;private $_headers;private $_content='';public function __construct($url){$this->_url=$url;$this->_headers=@get_headers($url,1);}public function getUrl(){return $this->_url;}public function getType(){if(!isset($this->_headers['Content-Type'])){return '';}if(is_array($this->_headers['Content-Type'])){return $this->_headers['Content-Type'][0];}return $this->_headers['Content-Type'];}public function getHttpCode(){$s=explode(' ',$this->_headers['0']);if(isset($s[1])){return $s[1];}return '';}public function getContent(){if($this->_content==''&&preg_match('|text/html|',$this->getType())){$this->_content=@file_get_contents($this->_url);}return $this->_content;}}function str_get_html($str){$dom=new simple_html_dom(null);$dom->load($str);return $dom;}class simple_html_dom_node{public $attr=array();public $_=array();function __construct($dom){$this->dom=$dom;$dom->nodes[]=$this;}function find($selector){$selectors=$this->parse_selector($selector);if(($count=count($selectors))===0)return array();for($c=0;$c<$count;++$c){if(($levle=count($selectors[$c]))===0)return array();$head=array($this->_[HDOM_INFO_BEGIN]=>1);for($l=0;$l<$levle;++$l){foreach($head as $k=>$v){$n=($k===-1)?$this->dom->root:$this->dom->nodes[$k];$n->seek($selectors[$c][$l],$ret);}$head=$ret;}foreach($head as $k=>$v){$found_keys[$k]=1;}}foreach($found_keys as $k=>$v)$found[]=$this->dom->nodes[$k];if(is_null)return $found;return(isset($found))?$found:null;}protected function seek($selector,&$ret){$end=(!empty($this->_[HDOM_INFO_END]))?$this->_[HDOM_INFO_END]:0;for($i=$this->_[HDOM_INFO_BEGIN]+1;$i<$end;++$i){$pass=true;if($pass)$ret[$i]=1;}}protected function parse_selector($selector_string){$pattern="/([\w-:\*]*)(?:\#([\w-]+)|\.([\w-]+))?(?:\[@?(!?[\w-:]+)(?:([!*^$]?=)[\"']?(.*?)[\"']?)?\])?([\/, ]+)/is";preg_match_all($pattern,trim($selector_string).' ',$matches,PREG_SET_ORDER);foreach($matches as $m){$result[]=array($val,);}if(count($result)>0)$selectors[]=$result;return $selectors;}function __get($name){if(isset($this->attr[$name])){return $this->attr[$name];}}}class simple_html_dom{protected $token_blank=" \t\r\n";protected $token_equal=' =/>';protected $token_slash=" />\r\n\t";protected $token_attr=' >';function load($str){$this->prepare($str);while($this->parse());return $this;}function find($selector){return $this->root->find($selector);}protected function prepare($str){$this->size=strlen($str);$this->doc=$str;$this->root=new simple_html_dom_node($this);$this->root->_[HDOM_INFO_BEGIN]=-1;}protected function parse(){if(($s=$this->copy_until_char('<'))===''){return $this->read_tag();}++$this->cursor;return true;}protected function read_tag(){if($this->char!=='<'){$this->root->_[HDOM_INFO_END]=$this->cursor;return false;}if($this->char==='/'){return true;}$node=new simple_html_dom_node($this);++$this->cursor;$tag=$this->copy_until($this->token_slash);$space=array($this->copy_skip($this->token_blank),);do{$name=$this->copy_until($this->token_equal);if($this->doc[$this->pos-1]=='<'){return true;}$space[1]=$this->copy_skip($this->token_blank);$this->char=(++$this->pos<$this->size)?$this->doc[$this->pos]:null;$this->parse_attr($node,$name,$space);$this->copy_skip($this->token_blank);}while($this->char!=='>'&&$this->char!=='/');return true;}protected function parse_attr($node,$name,&$space){switch($this->char){case '"':$this->char=(++$this->pos<$this->size)?$this->doc[$this->pos]:null;$node->attr[$name]=$this->restore_noise($this->copy_until_char_escape('"'));$this->char=(++$this->pos<$this->size)?$this->doc[$this->pos]:null;}}protected function copy_skip($chars){$pos=$this->pos;$len=strspn($this->doc,$chars,$pos);$this->pos+=$len;$this->char=($this->pos<$this->size)?$this->doc[$this->pos]:null;return substr($this->doc,$pos,$len);}protected function copy_until($chars){$pos=$this->pos;$len=strcspn($this->doc,$chars,$pos);$this->pos+=$len;return substr($this->doc,$pos,$len);}protected function copy_until_char($char){if(($pos=strpos($this->doc,$char,$this->pos))===false){$ret=substr($this->doc,$this->pos,$this->size-$this->pos);$this->pos=$this->size;return $ret;}$pos_old=$this->pos;$this->char=$this->doc[$pos];$this->pos=$pos;return substr($this->doc,$pos_old,$pos-$pos_old);}protected function copy_until_char_escape($char){$start=$this->pos;while(1){if(($pos=strpos($this->doc,$char,$start))===false){}$pos_old=$this->pos;$this->pos=$pos;return substr($this->doc,$pos_old,$pos-$pos_old);}}function restore_noise($text){return $text;}} ?>
